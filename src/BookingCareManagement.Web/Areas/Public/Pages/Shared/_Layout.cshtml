@using System.Security.Claims
@using Microsoft.AspNetCore.Identity
@using BookingCareManagement.Domain.Aggregates.User
@inject UserManager<AppUser> UserManager
@{
    var userPrincipal = User;
    var authed = userPrincipal?.Identity?.IsAuthenticated ?? false;
    AppUser? currentUser = null;
    string displayName = "User";
    string? resolvedAvatarUrl = null;

    if (authed && userPrincipal is not null)
    {
        currentUser = await UserManager.GetUserAsync(userPrincipal);
        var claimedName = userPrincipal.FindFirst(ClaimTypes.Name)?.Value;
        var resolvedName = currentUser?.GetFullName();
        var candidateName = string.IsNullOrWhiteSpace(resolvedName) ? claimedName : resolvedName;
        displayName = string.IsNullOrWhiteSpace(candidateName)
            ? (currentUser?.Email ?? "User")
            : candidateName!;

        var avatarUrl = currentUser?.AvatarUrl;
        if (!string.IsNullOrWhiteSpace(avatarUrl))
        {
            resolvedAvatarUrl = avatarUrl!.StartsWith("http", System.StringComparison.OrdinalIgnoreCase)
                ? avatarUrl
                : Url.Content(avatarUrl.StartsWith("~") ? avatarUrl : $"~/{avatarUrl.TrimStart('/')}");
        }
    }

    displayName = displayName.Trim().Length == 0 ? "User" : displayName.Trim();
    var fallbackInitial = displayName[0].ToString().ToUpperInvariant();
    var isAdmin = User?.IsInRole("Admin") ?? false;
    var isDoctor = User?.IsInRole("Doctor") ?? false;
    string? managementPortalHref = null;

    if (isAdmin)
    {
        managementPortalHref = Url.Content("~/dashboard");
    }
    else if (isDoctor)
    {
        managementPortalHref = Url.Content("~/doctor/dashboard");
    }

    string BuildProtectedLink(string virtualPath)
    {
        var resolvedPath = Url.Content(virtualPath);
        if (authed || string.IsNullOrWhiteSpace(resolvedPath))
        {
            return resolvedPath ?? virtualPath;
        }

        var loginUrl = Url.Page("/auth/Login", values: new { area = "Identity", returnUrl = resolvedPath });
        return loginUrl ?? Url.Content("~/auth/login")!;
    }

    var servicesNavHref = BuildProtectedLink("~/services");
    var bookingNavHref = BuildProtectedLink("~/booking");
    var myBookingsNavHref = BuildProtectedLink("~/my-bookings");
}
@* <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - BookingCareManagement</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/BookingCareManagement.styles.css" asp-append-version="true" />

    @* Allow pages to inject into a 'Head' section (many area pages use @section Head) 
    @RenderSection("Head", required: false)
    @RenderSection("Styles", required: false)
</head>
<body style="--navbar-height:72px; --footer-height:80px;">
    <div class="page-wrapper">
    <header>
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <div class="navbar-nav me-auto">
                    <a class="nav-link mx-3" href="/services">Services</a>
                    <a class="nav-link mx-3" href="/booking">Book Now</a>
                    <a class="nav-link mx-3" href="/my-bookings">My Bookings</a>
                </div>
                <div class="d-flex align-items-center user-info">
                    @if (authed)
                    {
                        <div class="user-badge">@userName.ToUpper()[0]</div>
                        <span class="user-name">@userName</span>
                    }
                    else {
                        <a href="/auth/login" class="user-name btn">Log In</a>
                    }
                </div>
            </div>
        </nav>
    </header>
    <main class="container @(ViewData["BodyClass"] ?? String.Empty)">
        @RenderBody()
    </main>
    <!-- Footer -->
    <footer class="custom-footer">
        <h2 class="footer-title">goodbone</h2>
        <hr class="footer-line">
        <p class="footer-text">Made with <img src="data:image/svg+xml,%3csvg%20width='42'%20height='14'%20viewBox='0%200%2042%2014'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M6.29747%203.84983C7.16722%203.84983%207.87229%203.14476%207.87229%202.27501C7.87229%201.40527%207.16722%200.700195%206.29747%200.700195C5.42773%200.700195%204.72266%201.40527%204.72266%202.27501C4.72266%203.14476%205.42773%203.84983%206.29747%203.84983Z'%20fill='white'/%3e%3cpath%20d='M11.024%203.84983C11.8938%203.84983%2012.5989%203.14476%2012.5989%202.27501C12.5989%201.40527%2011.8938%200.700195%2011.024%200.700195C10.1543%200.700195%209.44922%201.40527%209.44922%202.27501C9.44922%203.14476%2010.1543%203.84983%2011.024%203.84983Z'%20fill='white'/%3e%3cpath%20d='M6.29747%2013.2986C7.16722%2013.2986%207.87229%2012.5935%207.87229%2011.7237C7.87229%2010.854%207.16722%2010.1489%206.29747%2010.1489C5.42773%2010.1489%204.72266%2010.854%204.72266%2011.7237C4.72266%2012.5935%205.42773%2013.2986%206.29747%2013.2986Z'%20fill='white'/%3e%3cpath%20d='M11.0237%2010.1491C10.9401%2010.1491%2010.8564%2010.1589%2010.7777%2010.1688C9.69005%2010.341%208.12015%208.93354%207.87409%207.74258V6.21206C7.87409%205.77898%207.51975%205.42465%207.08668%205.42465H5.55615C4.53744%205.21303%203.36125%204.03684%203.14963%203.01813V0.700195H0V3.84983H2.31793C3.33664%204.06145%204.51284%205.23764%204.72445%206.25635V7.78687C4.72445%208.21995%205.07879%208.57428%205.51186%208.57428H7.04239C8.23334%208.82035%209.64084%2010.3902%209.46859%2011.4779C9.45383%2011.5566%209.4489%2011.6403%209.4489%2011.7239C9.4489%2012.6983%2010.3298%2013.4661%2011.3387%2013.2692C11.9538%2013.1511%2012.446%2012.654%2012.569%2012.0389C12.7609%2011.03%2011.9932%2010.1491%2011.0237%2010.1491Z'%20fill='white'/%3e%3cpath%20d='M16.0977%205.1442H17.8693V10.5478H19.5327V5.1442H21.3044V3.6875H16.0977V5.1442Z'%20fill='white'/%3e%3cpath%20d='M24.3504%205.78857C23.7057%205.78857%2023.1151%206.21673%2022.8887%207.05335V5.90668H21.3828V10.5475H22.9675V9.02187C22.9675%207.70788%2023.2874%207.28957%2023.932%207.28957C24.1929%207.28957%2024.4291%207.32894%2024.6506%207.40768L25.0393%205.91161C24.8474%205.82794%2024.621%205.78857%2024.3504%205.78857Z'%20fill='white'/%3e%3cpath%20d='M28.5834%205.91157V6.40862C28.3029%206.00999%2027.7862%205.79346%2027.299%205.79346C26.6936%205.79346%2026.1621%206.02476%2025.7143%206.4726C25.2665%206.92044%2025.0352%207.49623%2025.0352%208.22458C25.0352%208.95294%2025.2665%209.52873%2025.7143%209.97657C26.1621%2010.4244%2026.6887%2010.6459%2027.299%2010.6459C27.8649%2010.6459%2028.2931%2010.4342%2028.5834%2010.0258V10.5524H30.1681V5.91157H28.5834ZM28.2931%208.91849C27.924%209.28758%2027.3186%209.28758%2026.9299%208.91849C26.5608%208.5297%2026.5608%207.92438%2026.9299%207.55528C27.3186%207.1665%2027.924%207.1665%2028.2931%207.55528C28.6818%207.91946%2028.6818%208.5297%2028.2931%208.91849Z'%20fill='white'/%3e%3cpath%20d='M40.9143%205.91194V4.24854H39.3543V5.91194H38.5078V7.07337H39.3543V10.5478H40.9143V7.07337H41.8887V5.91194H40.9143Z'%20fill='white'/%3e%3cpath%20d='M37.5834%203.47078C36.1907%203.47078%2035.354%204.26803%2035.354%205.7395V5.90683H35.103H34.4141H33.4938V5.7395C33.5036%205.23261%2033.7546%204.97178%2034.1385%204.97178H34.7339V3.46586H34.1385C32.7457%203.46586%2031.9091%204.26311%2031.9091%205.73458V5.90191H31.043V7.06826H31.9091V10.5427H33.4938V7.06826H34.4141H35.103H35.354V10.5427H36.9387V7.06826H37.9131V5.90191H36.9387V5.73458C36.9485%205.22769%2037.1995%204.96686%2037.5834%204.96686H38.0755H38.1838V3.46094H38.0755H37.5834V3.47078Z'%20fill='white'/%3e%3c/svg%3e" alt="footer-logo" " width="50" alt="Trafft logo"></p>
    </footer>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    @RenderSection("Scripts", required: false)
</body>
</html>*@

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - BookingCareManagement</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/chat-widget.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/BookingCareManagement.styles.css" asp-append-version="true" />
    
    @RenderSection("Head", required: false)
    @RenderSection("Styles", required: false)
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg fixed-top">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="/">
                    <div class="brand-icon">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <span class="brand-text fw-bold ms-2">Medicare</span>
                </a>
                <div class="navbar-nav me-auto">
                    <a class="nav-link mx-3" href="@servicesNavHref">Chuyên khoa</a>
                    <a class="nav-link mx-3" href="@bookingNavHref">Đặt lịch</a>
                    <a class="nav-link mx-3" href="@myBookingsNavHref">Lịch của tôi</a>
                </div>
                @if (authed){
                    <div class="dropdown">
                        <button class="btn account-btn btn-outline-light d-flex align-items-center user-info" id="userDropdown"
                                data-bs-toggle="dropdown" aria-expanded="false" style="border: none;">
                            @if (!string.IsNullOrWhiteSpace(resolvedAvatarUrl))
                            {
                                <img class="user-avatar me-2" src="@resolvedAvatarUrl" alt="@displayName avatar" />
                            }
                            else
                            {
                                <span class="user-avatar user-avatar--fallback me-2">@fallbackInitial</span>
                            }
                            <span class="fw-semibold user-name">@displayName</span>
                            <i class="bi bi-caret-down-fill ms-2"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userDropdown">
                            @if (!string.IsNullOrEmpty(managementPortalHref))
                            {
                                <li>
                                    <a class="dropdown-item d-flex align-items-center" href="@managementPortalHref">
                                        <i class="fa-solid fa-gauge-high me-2 text-success"></i>
                                        Qua trang quản lí
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider my-1" /></li>
                            }
                            <li><a class="dropdown-item" href="/customer/account-settings/personal-info">Cài đặt tài khoản</a></li>
                            <li><button id="logout-btn" class="dropdown-item text-danger" type="button">Đăng xuất</button></li>
                        </ul>
                    </div>
                }
                else {
                    <div class="d-flex align-items-center user-info">
                        <a href="/auth/login" class="user-name btn">Đăng nhập</a>
                    </div>
                }
            </div>
        </nav>
    </header>
    @* Logic: Nếu là trang FullWidth (như Home) thì không bọc container *@
    @if (ViewData["IsFullWidth"] as bool? == true)
    {
        <main class="@ViewData["BodyClass"]" style="min-height: 100vh;">
            @RenderBody()
        </main>
    }
    else
    {
        <div class="container" style="">
            @* Thêm margin-top vì navbar fixed *@
            <main class="@ViewData["BodyClass"]">
                @RenderBody()
            </main>
        </div>
    }

    <footer class="custom-footer">
        <div class="container">
            <h2 class="footer-title">medicare</h2>
            <hr class="footer-line">
            <p class="footer-text">
                Powered with care
                <img src="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='%234CAF50'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M19%2011h-6V5h-2v6H5v2h6v6h2v-6h6z'/%3e%3c/svg%3e"
                     alt="medical-cross-icon" width="24" height="24">
            </p>
            <p class="text-muted small mt-2">&copy; @DateTime.Now.Year BookingCareManagement. All rights reserved.</p>
        </div>
    </footer>

    <div class="chat-widget" data-chat-widget>
        <button type="button" class="chat-widget__toggle" data-chat-toggle aria-label="Mở hộp thoại hỗ trợ">
            <i class="fa-solid fa-comments"></i>
            <span class="chat-widget__badge d-none" data-chat-badge>0</span>
        </button>
        <div class="chat-widget__panel" data-chat-panel aria-hidden="true" aria-label="Hỗ trợ trực tuyến">
            <div class="chat-widget__header">
                <div>
                    <p class="chat-widget__title mb-0">Trợ lý BookingCare</p>
                    <small class="text-muted">Thường phản hồi trong vài phút</small>
                </div>
                <button type="button" class="btn btn-link text-light p-0 chat-widget__close" data-chat-close aria-label="Đóng cửa sổ chat">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="chat-widget__body">
                <div class="chat-widget__recipient-picker" data-chat-recipient-container>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <p class="chat-widget__recipient-label mb-0">Trao đổi với</p>
                            <small class="text-muted">Chọn bác sĩ đã đặt lịch hoặc đội ngũ hỗ trợ</small>
                        </div>
                        <select class="form-select form-select-sm chat-widget__recipient-select" data-chat-recipient aria-label="Chọn người nhận"></select>
                    </div>
                    <div class="chat-widget__recipient-meta" data-chat-recipient-meta>
                        <div class="chat-widget__recipient-avatar" data-chat-recipient-avatar>
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div>
                            <p class="chat-widget__recipient-name mb-0" data-chat-recipient-name>Đang tải...</p>
                            <small class="chat-widget__recipient-role" data-chat-recipient-role>--</small>
                        </div>
                    </div>
                    <div class="chat-widget__recipient-empty d-none" data-chat-recipient-empty>
                        <i class="fa-regular fa-circle-question me-2"></i>
                        <span>Chưa có người nhận khả dụng.</span>
                    </div>
                </div>
                <div class="chat-widget__loading" data-chat-loading>
                    <div class="spinner-border spinner-border-sm text-light" role="status" aria-hidden="true"></div>
                    <span>Đang kết nối...</span>
                </div>
                <div class="chat-widget__empty d-none" data-chat-empty>
                    <i class="fa-regular fa-comments mb-2"></i>
                    <p class="mb-0">Hãy cho chúng tôi biết bạn cần gì.</p>
                </div>
                <div class="chat-widget__messages" data-chat-messages aria-live="polite"></div>
            </div>
            <form class="chat-widget__composer" data-chat-form novalidate>
                <div class="chat-widget__error d-none" data-chat-error></div>
                <div class="chat-widget__composer-row">
                    <input type="text" class="form-control form-control-sm chat-widget__input" placeholder="Nhập tin nhắn..." data-chat-input autocomplete="off" />
                    <button type="submit" class="btn btn-primary btn-sm chat-widget__send" data-chat-send>
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>  
    <script src="~/js/main.js" asp-append-version="true"></script>

    @RenderSection("Scripts", required: false)
</body>
</html>